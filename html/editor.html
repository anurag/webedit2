<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="/src/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
</head>
<html>
	<body>
		<div class='topbar'>
			<a id="logolink" href="/"><img id="logo" title="table of contents" src="/welogo.png"></a>
			<div id="userdrop" class="dropdown">
				<button title='List User Options' id="userbutton" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sign In
					<span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
				</button>
				<ul id="useroptions" class="dropdown-menu dropdown-menu-right">
					<li><a name='settings' href="javascript:;">Settings</a></li>
					<li><a name='zip' href="javascript:;">Download All</a></li>
					<li><a name='about' href="javascript:;">About</a></li>
					<li><a name='logout' href="javascript:;">Logout</a></li>
				</ul>
			</div>
			<div title='List Project Options' id="projectdrop" class="dropdown">
				<button id="projectbutton" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
					<span id='folder' class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
				</button>
				<ul id="projectoptions" class="dropdown-menu">
					<li><a name='new' href="javascript:;">New Project ...</a></li>
					<li><a name='open' href="javascript:;">Open Project <span class='glyphicon glyphicon-triangle-right'></span></a></li>
					<li><a name='share' href="javascript:;">Share Project</a></li>
					<li><a name='rename' href="javascript:;">Rename Project</a></li>
					<li><a name='clone' href="javascript:;">Clone Project</a></li>
					<li><a name='zip' href="javascript:;">Download Project</a></li>
					<li><a style="color:red" name='archive' href="javascript:;">Delete Project</a></li>
				</ul>
			</div>
			<div class="onoff">
				<span title='Make Project Read Only' id='readonly' class="glyphicon glyphicon-pencil"></span>
				<span title='Make Project Public' id='ispublic' class="glyphicon glyphicon-globe"></span>
			</div>
		</div>
		<ul id="projectlist" class="dropdown-menu"></ul>
		<ul id="uploadlist" class="dropdown-menu"></ul>
		<ul id="globalfilelist" class="dropdown-menu"></ul>
		<ul id="filelist" class="dropdown-menu"></ul>
		<ul id="taboptions" class="dropdown-menu">
			<li><a name='viewtab' href="javascript:;">View Tab</a></li>	
			<li><a name='edittab' href="javascript:;">Edit Tab</a></li>	
			<li><a name='globalize' href="javascript:;">Make Global</a></li>	
			<li><a style="color:red" name='delete' href="javascript:;">Delete File</a></li>
		</ul>
		<ul id="adminlist" class="dropdown-menu dropdown-menu-right"></ul>
		<div class='viewchange' id='open'>
			<a title='Open Project In Viewer' id='openlink' target="_blank" href=''><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> </a>
		</div>
		<div title='Close View Window' class='viewchange' id='close'><span class="glyphicon glyphicon glyphicon-remove" aria-hidden="true"></span></div>
		<div title='Open View Window' class='viewchange' id='openview'><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span></div>
		<div class='row'>	
			<div class='column'>
				<div class='tabs'>
					<button class="tab" id='_html' style="box-shadow:#505050 1px -1px 1px 0px; border-bottom:none; z-index: 5;">html</button><!--
					--><button class="tab"  id='_addtab'>...</button>
				</div>
				<div id="editor"></div>
				<div id="inlineeditor"></div>
			</div>
 			<div class='column'>
				<iframe id='viewframe' src=''></iframe>
			</div>
		</div>
        <form id="fileform">
			<input id="fileupload" type="file" name="file" data-url="/upload">
		</form>
	</body>
	<style>
        .verticalLine {
            z-index: 10;
            border-left: 5px solid #2f2f2fd6;
            opacity: 0;
        }
        .verticalLine:hover {
            opacity: .2;
            cursor: pointer;
        }
        #viewframe {
	        z-index: 5;
	    }
	    .ace_scrollbar {
	        opacity: .3;
	    }
	    body {
	        background-color: #f7f7f7;
	    }
		#openeditlink {
			font-size: 14px;
			float: right;
			margin-right: 3px;
		}
		#taboption {
			position: absolute;
		}
		.topbar {
		    margin-top: 1px;
			display: inline-block;
			width: 100%;
		}
		.gylphicon {
			.top: 0;
		}
		#projectbutton {
		    border-radius: 10%;
			vertical-align: baseline;
			color: rgb(51, 122, 183);
	        background-color: #efefef36;
			font-size: 22;
			border: none;
			margin-left: 3px;
            text-shadow', '-2px 0 white, 0 1px white, 2px 0 white, 0 -1px white;
		}
		#projectbutton:hover {
			background-color: #e6e6e6d6;
		}
		.viewchange {
			font-size: 14px;
		}
		#editor {
			z-index: 6;
		}
		.onoff {
			display:inline-block;
			text-align: center;
			vertical-align:center;
		}
		#fileform {
			display: none;
		}
		#readonly {
		    border-radius: 10%;
			line-height: 40px;
			font-size: 22;
			color: #a5a5a5;
			height: 40;
			width: 40;
            text-shadow', '-2px 0 white, 0 1px white, 2px 0 white, 0 -1px white;
		}
		#readonly:hover {
			background-color: #e6e6e6d6;
			cursor: pointer;
		}
		#ispublic {
            text-shadow', '-2px 0 white, 0 1px white, 2px 0 white, 0 -1px white;
		    border-radius: 10%;
			line-height: 40px;
			font-size: 22;
			color: #a5a5a5;
			height: 40;
			width: 40;
		}
		#ispublic:hover {
            background-color: #e6e6e6d6;
			cursor: pointer;
		}
		.toggle.btn {
			height: 20px;
		}
		#openlink {
			font-size: 12px;
		}
		#open {
			margin-top: 5px;
			position: absolute;
			right: 20px;
			font-size: 14px;
			z-index: 10;
		}
		#close {
		    border-radius: 10%;
			color: #ff000080;
			margin-top: 5px;
			font-weight: 400px;
			position: absolute;
			z-index: 10;
			font-size: 13px;
			right: 3px;
		}
		#openview {
			display: none;
			margin-top: 10px;
			position: absolute;
			z-index: 10;
			right: 4px;
		}
		#openview:hover {
			cursor: pointer;
		}
		#close:hover {
			background-color: #e6e6e6d6;
			cursor: pointer;
			color: red;
		}
		#userbutton {
        	margin-right: 3px;
		    border-radius: 10%;
	        background-color: #efefef36;
			//color: black;
			//background-color: white;
			margin-top: 1px;
			float: right;
			padding: 0;
			//border: none;
		}
		#userbutton:hover {
			background-color: #e6e6e6d6;
		}
		.tabx {
			z-index: 50;
			background-color: #ff6d6d;
			width: 10px;
			position: absolute;
			color: white;
			font-size: 10;
			margin: auto;
			top: 0;
			right: 0;
			opacity: .7;
		}
		#cloud {
		    position: absolute;
		    left: 1;
		    top: 0;
		    opacity: .3;
		}
		.tabx:hover {
			opacity: .9;			
			background-color: #fd2b2b;
		}
		.tab {
		    font-family: "Trebuchet MS", Helvetica, sans-serif;
		    border-top-right-radius: 1px;
		    //border-top-left-radius: 2px;
			position:relative;
			border-color: #0000002e;
			border-width: 1px;
			border-style: solid;
			font-size: 14;
			padding-top: 10px;
			padding-bottom: 25px;
			background-color: rgb(249, 249, 249);
			height: 20px;
			min-width: 45px;
		}
		.tab:hover {
			background-color: rgb(216, 216, 216);
		}
		.tabs {
			background: #eee;
			border-radius: 0 3px 0 0;
		}
		#adminlist {
			top: 34px;
			right: 120px;
			position: absolute;
		}
		#projectdrop {
			display: inline-block;
		}
		#projectlist, #filelist, #globalfilelist, #uploadlist {
			top: 0;
			position: absolute;
			overflow: auto;
		    max-height: 350px;
		}
		#projectlist {
			margin-top: 75px;		
		}
		#filelist {
			margin-top: 43px;
		}
		#globalfilelist {
			margin-top: 100px;
		}
		#uploadlist {
			margin-top: 100px;
		}
		#userdrop {
			float: right;
		}
		.dropdown-menu {
			min-width: 50px;
		}
		#logo {
			vertical-align: middle;
			margin-left: 7px;
			margin-top: -8px;
			height: 30px;
		}
		#editor {
			z-index: 10px;
			height: 100%;
			align: bottom;
			right: 0;
			bottom: 0;
			left: 0;
		}
		#viewframe {
			position: absolute;
			border-top: none;
			border-bottom: none;
			border-right: 1px solid #b5b5b5;
			border-left: 1px solid #b5b5b5;
			background-color: white;
		}
		.row {
			display: flex;
			border-top: 1px solid #b5b5b5;
			margin-right: 0;
			margin-left: 0;
			margin-top: 1;
		}
		.btn {
			border-radius: 0px;
			height: 40px;
		}
	</style>
	<script>
		$('body').css({'height': (window.innerHeight)});
		$('#projectlist').css({'left': ($('#projectoptions').width() + $('#logo').width() + 12)});

		$(window).on('resize', function(){ 
			$('body').css({'height': (window.innerHeight)});
			alignlists();
			resizeframes(g.query)
		});
		
		window.onclick = function(event) {
			//console.log(event)
			//console.log($('#uploadlist').css("display"))
			if (event.target.name != "open" && $('#projectlist').css("display") != 'none') {
				$('#projectlist').hide();
			}
			if (event.target.id != "_globalfile" && $('#globalfilelist').css("display") != 'none') {
				$('#globalfilelist').hide();
			}
			if (event.target.id != "_addtab" && $('#filelist').css("display") != 'none') {
				$('#filelist').hide();
			}
			if (event.target.id != "_listuploads" && $('#uploadlist').css("display") != 'none') {
				$('#uploadlist').hide();
			}
			if (event.target.name != "makeme" && $('#adminlist').css("display") != 'none') {
				$('#adminlist').hide();
			}
			$('#taboptions').hide();
		}
		
		function alignlists() {		
			$('#projectlist').css({'left': ($('#projectoptions').width() + $('#logo').width() + 10)});
			let tablist = [];
			let change = 0;
			$('.tab').each((i, el) => tablist.push($(el).outerWidth()));
			//console.log(tablist);
			for (let i = 0; i < tablist.length; i++) {
				change = change + tablist[i];
			}
			//console.log(change);
			$('#filelist').css({'left': change});
			$('#globalfilelist').css({'left': change + $('#filelist').width()});
			$('#uploadlist').css({'left': change + $('#filelist').width()});
		}
		
		function resizeframes(query) {
			//console.log(query)
			let change = ($('#userbutton').height() + $('.tabs').height() + 10)
			$('.verticalLine').css({'height': window.innerHeight - change + $('.tabs').height()});
			if (query == '?run=edit') {
				$('#viewframe').css({'height': (window.innerHeight - change + $('.tabs').height()), 'width': window.innerWidth/2, 'left': window.innerWidth/2});
				$('#editor').parent().css({'height': (window.innerHeight - change), 'width': window.innerWidth/2});			
				$('.tabs').css({'width': window.innerWidth/2});
				$('#viewframe').show();
				$('#viewframe').parent().show();
			}
			if (query == '?run=editor') {
				$('#viewframe').css({'height': (window.innerHeight - change + $('.tabs').height()), 'width': 0, 'left': window.innerWidth});
				$('#editor').parent().css({'height': (window.innerHeight - change), 'width': window.innerWidth - 2});
				$('.tabs').css({'width': window.innerWidth - 2});
				$('#viewframe').parent().hide();
				$('#viewframe').hide();
			}
			if (!g.activeeditor) {
                swapeditors(false)
			} else {
                swapeditors(g.activeeditor)
			}
		}

		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCtsK9Nx0Fh7YzwZ8r7V2oXw_cB0XQG4z8",
			authDomain: "webedit-204210.firebaseapp.com",
			databaseURL: "https://webedit-204210.firebaseio.com",
			projectId: "webedit-204210",
			storageBucket: "webedit-204210.appspot.com",
			messagingSenderId: "1059738201826"
		};
		firebase.initializeApp(config);
		const admin = firebase.database().ref().child('admin');
		const cookieToUidref = firebase.database().ref().child('cookieToUid');
		const root = firebase.database().ref();
		const projects = firebase.database().ref().child('projects');
		
		var usersettingsref;
		var projectsettingsref;
		let settings = {global: {},
				user: {},
				project: {}}
		settings.global.ref = firebase.database().ref().child('projects/global/-LFApck9n3U1YdCYWKEA/files/-LFApgX73wXqJW4zMz4i');
		let g = {};		
		g.shared = [];
		
		
		function parsesettings(settings) {
			//console.log(settings)
			let split = settings.split(/\r\n|\r|\n/);
			let values = {};
			for (let i = 0; i < split.length; i++) {
				if (!split[i].includes('#') && split[i] != "") {
					let object = split[i].split(': ');
					let name = object[0]
					let value = object[1]
					values[name] = value;
				}
			}
			return values;
		}
		
		g.inlineeditor = ace.edit('inlineeditor');
		g.inlineeditor.setTheme("ace/theme/dawn");
		g.inlineeditor.session.setMode("ace/mode/html");
		let editor = ace.edit('editor');
		editor.setTheme("ace/theme/dawn");
		editor.session.setMode("ace/mode/html");
		stateObj = {foo: 'projs'};
		g.editor = {};
		//console.log(editor.commands)
		
		function getCook(cookiename) {
			var cookiestring = RegExp(""+cookiename+"[^;]+").exec(document.cookie);
			return decodeURIComponent(!!cookiestring ? cookiestring.toString().replace(/^[^=]+./,"") : "");
		}

		function setEditor(contents) {
			editor.setValue(contents);
			editor.gotoLine(0, 0);
			editor.focus();
		}
		
		function nametoid(ref, uid, name) {
			//console.log(uid, name);
			return ref.child(uid).orderByChild('name').equalTo(name).once('value')
			.then(function (snapshot) {
				let key;
				snapshot.forEach(function (snap) {
					if (snap.val().settings) {
						if (snap.val().settings.archived) return;
					}
					//console.log('key', snap.key)
					key = snap.key;
				});
				return key;
			});
		}		
		
		function nametoref(ref, uid, name) {
			//console.log(uid, name);
			return ref.child(uid).orderByChild('name').equalTo(name).once('value')
			.then(function (snapshot) {
				let key;
				snapshot.forEach(function (snap) {
					if (snap.val().settings) {
						if (snap.val().settings.archived) return;
					}
					//console.log('key', snap.key)
					key = snap.ref;
				});
				if (!key) {
					throw 'ref not found';
				}
				return key;
			});
		}		
		
		function listentosettings(projects, uid, project, key) {
			nametoref(projects, uid, project)
			.then(function(projectref) {
				return nametoref(projectref, 'files', '.settings');
			})
			.then(function(settingsref) {
				//console.log('settingsid', settingsref);
				settingsref.on('value', function(snapshot) {
					if (snapshot.val()) {
						settings[key] = parsesettings(snapshot.val().contents);
					} else {
						throw 'ref not found';
					}
					mergesettings();
				});
			})
			.catch(function() {
				settings[key] = {'setting': false};
				mergesettings();				
			});			
		}
		
		settings.firsttime = true;		
		function mergesettings() {
			if (!settings.firsttime || (settings.global && settings.user && settings.project)) {
				settings.settings = $.extend({}, settings.global, settings.user, settings.project);
				settings.firstime = false;
				render();
			}
		}
		
		function render() {
			//console.log(settings);
			if (settings.settings.tabColor) {
				$('.tab').css('background-color', settings.settings.tabColor);			
			} else $('.tab').css('background-color', 'rgb(249, 249, 249)');
			if (settings.settings.tabTextColor) {
				$('.tab').css('color', settings.settings.tabTextColor);
			} else $('.tab').css('color', 'black');
		}
		
		function findprojectbooleans(ref) {
			ref.child('settings').on('value', function(snapshot) {
				g.settings = snapshot.val();
				//console.log(g.settings)
				if (g.settings.ispublic) {
					$('#ispublic').css('color', '#337ab7');
					$('#ispublic').attr('title', 'Make Project Private');
				} else {
					$('#ispublic').css('color', '#a5a5a5');
					$('#ispublic').css('text-shadow', 'none');
					$('#ispublic').attr('title', 'Make Project Public');
				}
				//console.log(g.admins)
				if (g.settings.readonly || (!g.admins[g.uid] && (g.shared && !g.shared.includes(g.authemail)) && g.uid != g.authuid)) {
					$('#readonly').css('color', '#a5a5a5');				
					$('#readonly').attr('title', 'Make Project Readable');
					editor.renderer.$cursorLayer.element.style.display = "none";
					editor.setOptions({
						readOnly: true,
						highlightActiveLine: false,
						highlightGutterLine: false
					});
				} else {
					$('#readonly').css('color', '#337ab7');
					$('#readonly').attr('title', 'Make Project Read Only');
					editor.renderer.$cursorLayer.element.style.display = "";
					editor.setOptions({
						readOnly: false,
						highlightActiveLine: true,
						highlightGutterLine: true
					});
					editor.focus();
				}
			});
		}
		

		$('.onoff').on('click', 'span', function(event) {
			//console.log(g.uid, g.authuid);
			if (event.target.id != '' && g.uid == g.authuid)
				if (g.settings[event.target.id]) {
					g.currentprojectref.child('settings').child(event.target.id).set(false);
				} else {			
					g.currentprojectref.child('settings').child(event.target.id).set(true);
				}
		});
		
		g.firsttime = true;
		$(function () {
			//console.log(window.location);
			[g.host, g.uid, g.projectname, g.filename] = window.location.pathname.split('/');
			$('#openlink').attr("href", window.location.origin + '/' + g.uid + '/' + g.projectname + '/?run=viewer');
			$('#logolink').attr("href", '/' + g.uid + '/');
			g.query = window.location.search;
			listentosettings(projects, 'global', 'global', 'global')
			listentosettings(projects, g.uid, 'global', 'user')
			listentosettings(projects, g.uid, g.projectname, 'project')
			//console.log(settings);
			if (g.query == "?run=editor") {
				$('#close').hide();
				$('#open').hide();
				$('#openview').show();
			}
			resizeframes(g.query);
			alignlists();
			loadfromfirebase(g.uid, $('#projectlist'));
			loadfromfirebase('files', $('#uploadlist'));
			runproject(g.uid, g.projectname);
			listfiles('files', $('#filelist'));
			if (g.projectname != 'global') {
    			loadfromfirebase('globalfiles', $('#globalfilelist'));
			} else {
			    $('#globalfilelist').remove();
			    $('#_globalfile').remove();
			    $('#_uploadfile').css('border-bottom', "1px solid #d8d8d8");
			}
			nametoref(projects, g.uid, g.projectname)
			.then(function(projectref) {
				g.currentprojectref = projectref;
				findprojectbooleans(g.currentprojectref);
				g.currentprojectref.child('settings').child('longname').set(g.projectname.replace(/_/g," "));
				g.currentprojectref.once('value')
				.then(function (snapshot) {
			        $('#_html').html(snapshot.val().settings.longname);
					g.shared = snapshot.val().shared;
					g.contents = snapshot.val().contents;
					setEditor(g.contents);
					slice();
					console.log('activetab', snapshot.val().activetab.name)
					if (snapshot.val().activetab.name) {
						g.activetab = snapshot.val().activetab.name;
					}
					g.currentprojectref.on('value', function(instancesnap) {
					   console.log(instancesnap.val().instance);
						if (instancesnap.val().contents != g.contents) {
                            g.contents = instancesnap.val().contents;
                            runproject(g.uid, g.projectname);
                            if (g.instance != instancesnap.val().instance.time) {
                                setEditor(g.contents);
                            }
						}
					});
					g.currentprojectref.child('activetab').on('value', function(activetabsnap) {
						console.log(g.activetab, activetabsnap.val(), getCook('instance'), activetabsnap.val().instance == getCook('instance'))
						if (activetabsnap.val().name && (activetabsnap.val().instance == getCook('instance') || g.openready) && activetabsnap.val() != '_html') {
							delete g.openready
							//console.log('firebasefile');
							let filename = activetabsnap.val().name.replace('.', '-');
							if (!$('#' + filename)[0] && (!g.lastchange || g.editor[activetabsnap.val().name])) {
								//console.log(activetab);
								addtab(filename.replace('-', '.'));			
							}
						}
					});
					g.currentprojectref.child('files').on('child_changed', function(filechange) {
						//console.log('filechange', g[filechange.val().name]);
						//if (g[filechange.val().name] != filechange.val().contents) {
						//	runproject(g.uid, g.projects);
						//}
					});
					g.currentprojectref.child('shared').on('value', function(shared) {
						//console.log(g.shared);
					});
				});
			});
		});		

		function loadadmins(uid) {
			root.child('admin').child('admins').once('value', function (snapshot) {
				g.admins = snapshot.val();
				checkadminstatus(uid);
			});
		}
		
		function checkadminstatus(uid) {
			if (g.admins[uid]) {
				$('#useroptions').prepend('<li><a name="makeme" href="javascript:;">Change User</a></lis>')
				listadmins(projects);
			}
		}
		
		function listadmins(ref) {
			ref.on('child_added', function(snapshot) {
				//console.log(snapshot.val().email, snapshot.key);
				let html = ('<li><a id="' + snapshot.key + '" href="/' + snapshot.key + '/">' + snapshot.val().email + '</a></li>');
				$('#adminlist').append(html);
			});
		}
		
		function loadprojects(uid, list) {
			loadfromfirebase(projects, g.uid, $('#projectlist'));
		}
		
		function listfiles(uid, list, addons) {
		    list.html("");
			loadfromfirebase('files', $('#filelist'));
			//if (!addons) {
    			let html = '<li><a style="border-bottom: 1px solid #d8d8d8;" id="_globalfile" href="javascript:;">Global Files<span class="glyphicon glyphicon-triangle-right"></span></a></li>'
    			list.prepend(html);
				//	<li><a name='uploads' href="javascript:;">View Uploads <span class='glyphicon glyphicon-triangle-right'></span></a></li>
    		    html = '<li><a id="_listuploads" href="javascript:;">View Uploads<span class="glyphicon glyphicon-triangle-right"></span></a></li>'
    			list.prepend(html);
    		    html = '<li><a id="_uploadfile" href="javascript:;">Upload File ...</a></li>'
    			list.prepend(html);
    			html = '<li><a id="_addfile" href="javascript:;">New File ...</a></li>'
    			list.prepend(html);
			//}
		}
		
		//<li><a name='new' href="javascript:;">New Project +</a></li>New Project +</a></li>
		function loadfromfirebase(uid, list) {
		    console.log(list[0].id)
			//list.html("");
			let url = '.files.json'
	    	if (uid == 'globalfiles') {
			    url = '../global/.files.json';
			}
			if (uid != 'files' && uid != 'globalfiles') {
				url = '/' + uid + '/' + url;
			}
			$.getJSON(url)
			.then(data => {
				data.forEach(function (node) {
				    //console.log(node, list)
				    let name = node.name;
				    let longname = name;
				    let href = 'javascript:;';
				    let html;
					if (node.longname) longname = node.longname;
					if (list[0].id == "uploadlist") {
					    if (node.uploaded) {
						    href = node.name;
					        //console.log('uploaded', node)
						    html = ('<li><a target="_blank" id="' + name + '" href="' + href + '">' + longname + '</a></li>');
					    }
					} else if (list[0].id == "projectlist" && !node.archived) {
					    href = '../' + node.name + '/?run=edit';
				        //console.log('uploaded', node)
					    html = ('<li><a id="' + name + '" href="' + href + '">' + longname + '</a></li>');
				    } else if (!node.archived && !node.uploaded) {
						//console.log('local', node);
						html = ('<li><a id="' + name + '" href="' + href + '">' + longname + '</a></li>');
					}
					list.append(html);
				});
				if (!list[0].innerHTML || g.nofiles) {
					list.append('<li><a href="javascript:;">No Files</a></li>');
				}
			});
		}
		
        document.onpaste = function(e) {
           if (e.clipboardData) {
              let items = (e.clipboardData || e.originalEvent.clipboardData).items;
              for (var i = 0; i < items.length; i++) {
                  let item = items[i];
                  if (item.kind == 'file') {
                     console.log(item);
                     let blob = item.getAsFile();
                     let reader = new FileReader();
                     reader.onload = function(event) {
                         console.log(event.target.results);
                     }
                     reader.readAsDataURL(blob);
                  }
              }
           }
        }
         

		$('#viewframe').on('load', function() {
            let furl = {};
            [furl.host, furl.uid, furl.projectname, furl.filename] = document.getElementById('viewframe').contentWindow.location.pathname.split('/');
            //console.log(furl, furl.filename);
            if (furl.filename) {
                //console.log('openready');
                g.openready = true;
            }
		});
		
		$('#openview').on('click', function () {
			top.window.history.replaceState(stateObj, name, '../' + g.projectname + '/?run=edit');
			$('#close').show();
			$('#open').show();
			$('#openview').hide();
			g.query = "?run=edit";
			resizeframes(g.query);
			runproject(g.uid, g.projectname)
		});
		
		$('#openlink').on('click', function () {
		    $('#close').click();
		});
		
		$('#close').on('click', function () {
			top.window.history.replaceState(stateObj, name, '../' + g.projectname + '/?run=editor');
			$('#close').hide();
			$('#open').hide();
			$('#openview').show();
			g.query = '?run=editor';
			resizeframes(g.query);
		});
		
		$('#useroptions').on('click', 'a', function (event) {
			let option = event.target.name;
			if (option == 'settings') {
				top.window.history.pushState(stateObj, name, '../' + '.settings' + '/' + g.query);
				top.window.location.reload();
			}
			if (option == 'makeme') {
				event.stopPropagation();
				$('#adminlist').show();
			}
			if (option == 'logout') {
				logout();
			}
			if (option == 'about') {
			    // + $(location).attr("pathname") + '?run=about'
			    console.log($(location).attr("pathname") + '?run=about')
    			top.window.location.href = ('/0GZ6h7paIPSfwN6kvMqxv85p9XX2/admin/about.html');
				//$('#viewframe')[0].contentWindow.location = $(location).attr("origin") + '/0GZ6h7paIPSfwN6kvMqxv85p9XX2/admin/about.html';	
 			}
			if (option == 'zip') {
				window.open($(location).attr("origin") + '/' + g.uid + '/' + "?run=download");
				window.close();
			}
		});
		
		function addshare() {
			let email = prompt("Email of user");
			let emaillist = [];
			$('#adminlist a').each((i, el) => emaillist.push($(el).text()))
			//console.log(emaillist);
			while (email && !emaillist.includes(email)) {
				email = prompt("That user does not exist please");
			}
			if (!g.shared) {
				g.shared = [email];
			} else {
				g.shared.push(email);
			}
			g.currentprojectref.child('shared').set(g.shared);
		}
		
		
		$('#projectoptions').on('click', 'a', function (event) {
			let option = event.target.name;
			if (option == 'share') {
				addshare();
			}
			if (option == 'new') {
				event.stopPropagation();
				create(projects, g.uid, "");
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'open') {
				event.stopPropagation();
				$('#projectlist').show();
			}
			if (option == 'rename') {
				renameproject();
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'clone') {
                create(projects, g.uid, g.contents, '.clone');
			}
			if (option == 'archive') {
				if (confirm('Do you want to archive project ' + g.projectname + '?')) {
					g.currentprojectref.child('settings').update({
						archived: true
					});
					$('#logo').click();
				}
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'zip') {
				window.open($(location).attr("origin") + $(location).attr("pathname") + "?run=download");
				window.close();
			}
		});
		
		function create(ref, uid, newcontents, name) {
		    let clone;
		    let files = '';
		    if (name = '.clone') {
		        clone = true;
		    }
			if (!name || name == '.clone') {
				name = prompt("New project name?");	
			}
            g.currentprojectref.child('files').once('value')
            .then(function (snapshot) {
                if (clone) {
                   files = snapshot.val(); 
                   //console.log('files',  files);
                }
                longname = name;
    			name = checkname(name)
    			ref = ref.child(uid);
    			//console.log(name)
    			let created = ref.push({
    				contents: newcontents,
    				name: name,
    				longname: longname,
    				lastchange: firebase.database.ServerValue.TIMESTAMP,
    				files: files,
    				settings: {name: name,
    				ispublic: false,
    				archived: false,
    				readonly: false,}
    			})
    			top.window.history.pushState(stateObj, name, '../' + name + '/?run=edit');
    			top.window.location.reload();
            });
		}
		
		$('#fileupload').change(function (event) {
			event.stopPropagation();
			let file = $('#fileupload')[0].files[0];
			let fd = new FormData();
			fd.append('file', file);
			fd.append('uid', g.uid);
			fd.append('projectname', g.projectname);
			//console.log(fd, file);
			jQuery.ajax("/upload", {
				type: "POST",
				processData: false,
				contentType: false,
				data: fd
			});
		});

		function editglobalfile(ref, uid, projectname, filename) {
		    nametoref(ref, uid, "global")
		    .then(function (globalref){
		        editfile(globalref, 'files', filename, true)
		    })
		}
		
		$('#globalfilelist').on('click', 'a', function (event) {
			let name = event.target.id;
			//console.log(name)
			addtab('global_' + name, true);
		});
		
		$('#filelist').on('click', 'a', function (event) {
		    let name = event.target.id;	
			//console.log(name);
			if (name == "_addfile") {
				addfile(g.currentprojectref, 'files', "");
				listfiles('files', $('#filelist'), true);
			} else if (name == "_globalfile") {
			    event.stopPropagation();
			    $('#globalfilelist').show();
			} else if (name == "_uploadfile") {
				$('#fileupload').click();
			} else if (name == "_listuploads") {
			    event.stopPropagation();
				$('#uploadlist').show();
			} else {
				addtab(name);
			}
		});
		
		function tabstyle(tab) {
			$('.tab').css({'box-shadow':'', 'border-bottom':'', 'z-index': 0});
			tab.css({'box-shadow':'black 0px -1px 1px 0px', 'border-bottom':'none', 'z-index': 5});		
		}
		
		function parsehtml(contents) {
			let parser = new DOMParser();
			let html = parser.parseFromString(contents, "text/html");		
			return html;
		}
		
		function findinlinetabs(contents) {
			let html = parsehtml(contents);
			let tabs = html.querySelectorAll('[we-tab]');
			tabs.forEach(function(tab) {
				addtab(tab.getAttribute('we-tab'));
			});
		}
		
		
		$('.tabs').on('click', 'span', function (event) {
		    if (event.target.className == 'tabx') {
    			event.target.parentNode.remove();
    			//console.log(event.target.parentNode.id);
    			$('#' + event.target.parentNode.id).remove();
    			let refname = event.target.parentNode.id.replace('-', '.');
    			delete g.editor[refname];
    			let ref = g.fileref[refname];
    			ref.off();
    			alignlists();
    			listfiles('files', $('#filelist'), true);
    			loadfromfirebase('globalfiles', $('#globalfilelist'));
    			$('#_html').click();
		    }
		});
		
		//tlasdoalsdhtneosdyjtonoasnth adfasdntyythiesasdf
		$('.tabs').on('click', 'button', function(event) {
			if (event.target.id) {
			    if (event.target.id != '_addtab') {
				    tabstyle($(this));
			    }
				if (event.target.id == '_inlinetab') {
					//console.log(event.target.id);
					g.activetab = event.target.id;					
					top.window.history.replaceState(stateObj, name, '/' + g.uid + '/' + g.projectname + '/' + g.query);
					swapeditors('inline');
					g.inlineeditor.focus();
					//console.log(g.inlinetabval)
					slice();
				} else {
					if (event.target.id == '_addtab') {
						$('#filelist').show();
					} else if (event.target.id == '_html') {
						g.activetab = event.target.id;
						top.window.history.replaceState(stateObj, name, '/' + g.uid + '/' + g.projectname + '/' + g.query);
						//console.log('2');
						seteditormode('index.html');
						if (g.contents != editor.getValue()) {
						    //console.log('test')
    						setEditor(g.contents)
		                	editor.gotoLine(0, 0);
						}
						swapeditors(false);			
						editor.focus();
					} else {
					   // console.log('file', event.target.name)
					    if (event.target.name == 'global') {
					        editglobalfile(projects, g.uid, 'global', event.target.id);
					    } else {
    						g.activetab = event.target.id;
    						top.window.history.replaceState(stateObj, name, g.activetab.replace('-', '.') + g.query);
    						//console.log('edit 1')
    						editfile(g.currentprojectref, 'files', g.activetab)
    						//swapeditors(false);	
					    }
					}
				}
			}
		});
		
		function seteditormode(filename, edit) {
		    if (!edit) {
		        edit = editor;
		    }
		    let type = filename.replace(/^.*\.(.*)$/, "$1");
        	if (type == 'js') {type = 'javascript'};
        	if (type == 'htm' || type == 'settings') {type = 'html'};
        	edit.session.setMode('ace/mode/' + type);
		};
		
		$('.tabs').contextmenu(function (event) {
			if (!event.shiftKey && event.target.className != 'tabs' && event.target.name != 'global' && event.target.id != '_html' && event.target.id != "_inlinetab"  && event.target.id != "_addtab" && event.target.id != "openeditlink") {
				g.rightclicked = event.target.id.replace('-', '.');
				event.preventDefault();
				//console.log(event.originalEvent);
				$('#taboptions').css({'left': event.originalEvent.pageX, 'top': event.originalEvent.pageY});
				$('#taboptions').attr('clicked', g.clicked);
				$('#taboptions').show();
			} else $('#taboptions').hide();
		});
		
		$('#taboptions').on('click', 'a', function (event) {
			let target = event.target;
			let option = target.name;
			if (option == 'viewtab') {
				$('#viewframe').attr('src', window.location.origin + '/' + g.uid + '/' + g.projectname + '/' + g.rightclicked);
			} 
			if (option == 'edittab') {
				//console.log(window.location.pathname);
				window.open(window.location.origin + '/' + g.uid + '/' + g.projectname + '/' + g.rightclicked + '?run=edit');
			}
			if (option == 'delete') {
				//console.log(g.activetab, g.rightclicked);
                g.fileref[g.rightclicked].child('archived').set(true);
                $('#' + g.rightclicked.replace('.', '-')).find('span.tabx').click();;
			}
			if (option == 'globalize') {
			    console.log(g.rightclicked)
				nametoref(projects, g.uid, 'global')
				.then(function(globalref) {
				    console.log(globalref.key);
					return nametoref(globalref, 'files', g.rightclicked)
					.then(function (globalfilesref) {
				        console.log(globalfilesref.key);
						if (confirm('Making this file global will change the global file of the same name.')) {
						    nametoref(g.currentprojectref, 'files', g.rightclicked)
        				    .then(function (fileref) {
        				        console.log(fileref.key);
        				        return fileref.once('value');
        				    })
        				    .then(function (snapshot) {
        				        console.log(snapshot.key, globalfilesref.key);
        				        globalfilesref.set({name: snapshot.val().name, contents: snapshot.val().contents});
                				$('#' + g.rightclicked.replace('.', '-')).find('span.tabx').click();;
                				alignlists();
                				g.fileref[g.rightclicked].child('archived').set(true);
                				g.fileref[g.rightclicked].off();
                    			listfiles('files', $('#filelist'), true);
                    			loadfromfirebase('global', $('#globalfilelist'));
                    			addtab('global_' + g.rightclicked, true);
         				    })
						}
					})
					.catch(function (err) {
						console.log(err);
						globalref.child('files').push({'name': g.rightclicked, 'contents': g[g.rightclicked]})
        				$('#' + g.rightclicked.replace('.', '-')).find('span.tabx').click();;
        				alignlists();
        				g.fileref[g.rightclicked].child('archived').set(true);
        				g.fileref[g.rightclicked].off();
            			listfiles('files', $('#filelist'), true);
            			loadfromfirebase('global', $('#globalfilelist'));
            			addtab('global_' + g.rightclicked, true);
					});
				})
			}
			//delete g.rightclicked;
		});
		 

		function swapeditors(inline) {
			let change = ($('#userbutton').height() + $('.tabs').height() + 10)
			let width = window.innerWidth/2;
			$('#editor').parent().css({'height': (window.innerHeight - change), 'width': window.innerWidth/2});			
			if (g.query == '?run=editor') {
			    width = window.innerWidth;
			}
			if (inline == 'inline') {
			    //console.log('editor')
				$('#editor').css({'height': 0, 'width': width});									
				$('#inlineeditor').css({'height': (window.innerHeight - change), 'width': width});
				$('[name=fileeditor]').css({'height': 0, 'width': width});
				g.activeeditor = 'inline';
			} else if (inline == false) {
			    //console.log('inlineeditor')
				$('#editor').css({'height': (window.innerHeight - change), 'width': width});				
				$('#inlineeditor').css({'height': 0, 'width': width});									
				$('[name=fileeditor]').css({'height': 0, 'width': width});
				g.activeeditor = false;
   			    editor.resize();
                editor.commands.bindKeys({"ctrl-l":null})
            } else if (inline != "_html") {
			    //console.log('fileeditor')
				$('#inlineeditor').css({'height': 0, 'width': width});									
				$('[name=fileeditor]').css({'height': 0, 'width': width});
				$('#editor').css({'height': 0, 'width': width});
				//console.log($('#editor' + inline.replace('.', '-')), g.editor[inline])
				$('#editor' + inline.replace('.', '-')).css({'height': (window.innerHeight - change), 'width': width});
				$('#editor' + inline.replace('.', '-')).parent().css({'height': (window.innerHeight - change), 'width': width});
 				g.activeeditor = inline;
   			    g.editor[inline].resize();
                g.editor[inline].commands.bindKeys({"ctrl-l":null})
 			}
		}
		
		function globaltolocal(contents, name) {
		   // console.log(editor.getValue(), name);
         	$('#' + name.replace('.', '-')).find('span.tabx').click();
		    addfile(g.currentprojectref, 'files', contents, name.replace('global_', ''));
		}
		
		g.fileref = {};
		function editfile(ref, uid, name, global) {
			//console.log(uid, name);
			name = name.replace('-', '.');
            //console.log(g);
			if (!g.editor[name]) {
			    console.log('no editor');
				let html = '<div name="fileeditor" id="editor' + name.replace('.', '-') + '"></div>'
				$('#editor').after(html);
    			g.editor[name] = ace.edit('editor' + name.replace('.', '-'))
        		g.editor[name].setTheme("ace/theme/dawn");
    	    	g.editor[name].session.setMode("ace/mode/html");
 	    		g.editor.firstime = true;
       	    	if (global) {
    	    		$(g.editor[name].textInput.getElement()).keyup(function (event) {
    	        	    //console.log('editor', g.editor[name].getValue(), 'name', g[name]);
                        if (confirm('Edit global file')) {
                            g.demotedcursorpos = g.editor[name].getCursorPosition();
                            g.demotededitorval = g.editor[name].getValue()
                            console.log(g.demotedcursorpos);
                            globaltolocal(g[name], name);
                        }
        	        	//console.log('editor', g.editor[name].getValue(), 'name', g[name]);
    	    		    g.dirtyTime = Date.now();
    	    		});
    	    	} else {
    	    		g.editor[name].on('change', function() {
    	    		   g.dirtyTime = Date.now(); 
    	    		});
    	    	}
	    		g.editor.firstime = true;
			}
			seteditormode(name, g.editor[name]);
			if (g[name]) {				
				console.log('if g[name]');
				if (g.editor[name].getValue() != g[name]) {
    				g.editor[name].setValue(g[name]);
				}
	    		swapeditors(name);
    			g.editor[name].focus();
			} else {
				console.log('else')
				nametoref(ref, uid, name.replace('global_', ''))
				.then(function(fileref) {
					g.fileref[name] = fileref;
					g.fileref[name].on('value', function(snapshot) {
						let namecomp = name.replace('.', '-');
						console.log('on file ref')
						if (g[name] != snapshot.val().contents) {
							//console.log('on file contents', g.instance, snapshot.val().instance)
							g[name] = snapshot.val().contents;
							if (g[name]) {
			            		$('#viewframe')[0].contentWindow.location.reload();
							}
							//console.log(g[name])
							//console.log(g.editor[name].getValue())
						}
						if (global || (g.editor[name].getValue() == '')) {
							//console.log('on file editor', name)
							//console.log('4');
		               		openeditor(g.editor[name], name, g[name]);
		    				delete g.editor.firstime;
						}
						if (g.instance == snapshot.val().time && name == snapshot.val().instance.name) {
						    console.log(name)
						    console.log('file instance', g.instance, snapshot.val().instance)
            				g.editor[name].setValue(g[name]);
	        		        g.editor[name].selection.moveTo(0, 0);
						}
					});
				});			
			}
		}
		
		function openeditor(openeditor, name, contents) {
		    if (g.demotededitorval) {
		        contents = g.demotededitorval;
		        delete g.demotededitorval;
		    }
		    openeditor.setValue(contents);
		    if (g.demotedcursorpos) {
		        openeditor.selection.moveTo(g.demotedcursorpos.row, g.demotedcursorpos.column);
		        delete g.demotedcursorpos;
		    } else {
              	openeditor.selection.moveTo(0, 0);
		    }
       		openeditor.focus();
		    swapeditors(name);
		}
		
		function addtab(name, global) {
			let idname = name.replace('.', "-")
			if ($('#' + idname)[0]) {
				$('#' + idname).click();
			} else {
				let html = '<button title="Local File: ' + name + '" class="tab" id="' + idname + '">' + name + '<span class="tabx">x<span></button>'
				if (global) {
				    html = '<button title="Global File: ' + name.replace("global_", '') + '"  style="background-image: linear-gradient(45deg, #dcecf7 37.50%, #dbf1ff 37.50%, #dbf1ff 50%, #dcecf7 50%, #dcecf7 87.50%, #dbf1ff 87.50%, #dbf1ff 100%);background-size: 22.63px 22.63px;" name="global" class="tab" id="' + idname + '">' + name.replace("global_", '') + '<span class="tabx">x<span></button>'
				}
				$('#_addtab').before(html);
				$("#" + idname).click();
			} 
			alignlists();
		}
			
		function addfile(ref, uid, newcontents, name) {
			let filelist = [];
			if (!name) {
				name = prompt("New file name?");	
			}
			if (!name.includes('.')) {
				name = prompt("Please Specify Filetype");
			}
			$('#filelist a').each((i, el) => filelist.push(mangle($(el).text())))
			for (;;) {
				if (!filelist.includes(name)) break;
				name = prompt("That name is taken please choose another.");		
				if (!name.includes('.')) {
					name = prompt("Please Specify Filetype");
				}
			}
			let created;
			created = ref.child(uid).push({
				contents: newcontents,
				name: name,
				lastchange: firebase.database.ServerValue.TIMESTAMP,
			})
			addtab(name);
		}	
		
		
		function mangle(s) {
			return s.replace(/ /g,"_");
		}
		
		function checkname(name) {
			let namelist = [];
			$('#projectlist a').each((i, el) => namelist.push(mangle($(el).text())))
			//console.log(namelist)
			for (;;) {
				name = mangle(name);
				if (!namelist.includes(name)) break;
				name = prompt("That name is taken please choose another.");		
			}
			return name;
		}
		
		function renameproject() {
			let newname = prompt('What would you like to rename project: ' + g.projectname + '?');
			newname = checkname(newname)
			g.currentprojectref.child('settings').update({
				name: newname,
			});
			g.currentprojectref.update({
				name: newname,
			});								
			top.window.history.pushState(stateObj, name, '../' + newname + '/?run=edit');
			top.window.location.reload();
		}

		function slice() {
			console.log("slice")
			let lines = editor.session.doc.getAllLines();
			let inlinetabname;
			let startline;
			let endline;
			for (let i = 0; i < lines.length; i++) {
				//console.log('line:', i, lines[i]);
				if (!startline) {
				    //console.log('start', startline)
					if (lines[i].includes('<script') && lines[i].includes('we-tab')) {
					    if (lines[i].includes('text/markdown')) {
					        console.log('markdown');
					        //g.inlineeditor.getSession().setUseWrapMode(true);
					        //g.inlineeditor.session.setOption("indentedSoftWrap", false)
					    }
						startline = i + 1;
						if (lines[i].includes('we-tab=')) {
						    [,,inlinetabname] = lines[i].match(/we-tab=(['"])(.*?)\1/);
						}
						//console.log(tabname);
					}
				} else {
					lines[i] = lines[i]
					if (lines[i].includes('</scr' + 'ipt>')) {
						endline = i - 1;
						break;
					}
				}
			}
			if (!startline || !endline) return;
			if (!$('#_inlinetab')[0]) {
				$('#_html').after('<button class="tab" id="_inlinetab">' + inlinetabname + '</button>');
			}
			g.inlinetabval = lines.slice(startline, endline + 1);
			for (let i = 0; i < g.inlinetabval.length - 1; i++) {
				g.inlinetabval[i] = g.inlinetabval[i] + '\n';
			}
			if (g.inlineeditor.getValue() != g.inlinetabval.join('')) {
			    g.inlineeditor.setValue(g.inlinetabval.join(""));
	    		g.inlineeditor.gotoLine(0, 0);
			} else g.inlineeditor.resize();
			//rebuild(startline, endline);
			alignlists();
		}
		
		function rebuild(start, end) {
			let alllines = editor.session.doc.getAllLines();
			let lines = g.inlineeditor.session.doc.getAllLines();
			let startline;
			let endline;
			console.log("rebuild")
			for (let i = 0; i < alllines.length; i++) {
				if (!startline) {
					if (alllines[i].includes('<script') && alllines[i].includes('we-tab')) {
						startline = i + 1;
					}
				} else {
					if (alllines[i].includes('</scr' + 'ipt>')) {
						endline = i - 1;
						break;
					}
				}
			}
			alllines.splice(startline, endline - startline + 1, ...lines);
			for (let i = 0; i < alllines.length - 1; i++) {
				alllines[i] = alllines[i] + '\n';
			}
			alllines.splice(alllines.length - 1, 1);
			//console.log('rebuild');
			if (editor.getValue() != alllines.join('')) {
	    		editor.setValue(alllines.join(''));
		    	editor.gotoLine(0, 0);
			}
			//editor.resize();
		}
		
		editor.session.on('change', function() {
			if (editor.getValue() != g.contents) {
				//console.log('slice');
				slice();
			}
			g.dirtyTime = Date.now();
		});
		
		$(editor.textInput.getElement()).keydown(function () {
			//console.log('key')
			g.dirtyTime = Date.now();
		});
		
		$(g.inlineeditor.textInput.getElement()).keydown(function () {
			//console.log('key')
			if (g.dirtyTime) g.dirtyTime = Date.now();
		});

		g.inlineeditor.session.on('change', function() {
			if (g.inlineeditor.getValue() != g.inlintabval && g.activetab == "_inlinetab") {
				//console.log('rebuild')
				rebuild()
			}
			g.dirtyTime = Date.now();
		});
		
		$('#userbutton').click(function(event) {
			//console.log('userbutton');
			if (g.authuid) {

			} else {
				let provider = new firebase.auth.GoogleAuthProvider();
				firebase.auth().signInWithPopup(provider).then(function(result) {
				}).catch(function(error) {
				});
			}
		});
		
		firebase.auth().onAuthStateChanged(function (user) {
			if (user) {
				$('#userbutton').html(user.email.split("@")[0])
				g.cookieId = getCook('cookieId');
				g.authemail = user.email;
				g.authuid = user.uid;
				$('#userbutton').css({'border': 'none'});
				$('#userbutton').html('<div style="display: inline-block; color: #abcff5; margin-right: 5px;"><img style="border-radius: 50%; height: 38px; padding: 5px;" src="' + user.photoURL + '"></img><span class="glyphicon glyphicon-triangle-bottom"></span>');
				root.child('cookieToUid').child(g.cookieId).set(g.authuid);
				loadadmins(g.authuid);
			}
		});		

		function logout() {
			firebase.auth().signOut().then(function() {
				window.history.pushState(stateObj, "page 2", "/")
				window.location.reload();
			}, function(error) {
				// An error happened.
			});
		};

		function setItem(key, val) {
		    localStorage.setItem(key, JSON.stringify(val));
		}
		function getItem(key) {
		    return JSON.parse(localStorage.getItem(key));
		}
        function crashed_set(project, val) {
            let crashed = getItem('crashed_by_project') || {};
            //console.log('crashed_by_project', crashed);
            crashed[project] = crashed[project] || {};
            crashed[project].crashed = val;
            setItem('crashed_by_project', crashed);
        }
        function crashed_get(project) {
			$('#line').show();
			$('#rframe').show();
			$('#lframe').show();
			let crashed = getItem('crashed_by_project') || {};
            crashed[project] = crashed[project] || {};
            return (crashed[project] || {}).crashed;
        }	
		let crash_timer_handle;
		function runproject(uid, projectname) {
			console.log('run', uid, projectname)
			if (g.query == '?run=edit') {
			//	console.log('crashed', crashed_get(projectname))
				if (crashed_get(projectname)) {
					$('#viewframe')[0].contentWindow.location = '?run=crashed';
					return;
				}			
				crashed_set(projectname, true);
				if (crash_timer_handle) clearTimeout(crash_timer_handle)	
				crash_timer_handle = setTimeout(function () {crashed_set(projectname, false)}, 500)
				let src = '/' + uid + '/'  + projectname + '/';
				let viewframe = $('#viewframe')[0];
				if ($('#viewframe')[0].contentWindow.location.href == 'about:blank') {
					//console.log('replace')
					$('#viewframe')[0].contentWindow.location.replace(src);	
				} else {
					//console.log('reload')
					$('#viewframe')[0].contentWindow.location.reload();
				}
			}
		}
		
		g.dirtyTime = null;
		setInterval(function () {
			if (g.dirtyTime && Date.now() - g.dirtyTime > 500) {
				let name = g.activetab.replace('-', '.')
				//console.log(name)
				let comptime = Date.now();
				g.dirtyTime = null;
				if (editor.getValue() != g.contents && (g.activetab == '_html' || g.activetab == '_inlinetab')) {
					console.log('firebaseprojectup');
					//g.contents = editor.getValue();
					g.instance = Date.now();
					g.currentprojectref.update({
						instance: {time: g.instance, name:"_html"},
						contents: editor.getValue(),
						lastchange: firebase.database.ServerValue.TIMESTAMP
					});
				} else if (g.editor[name] && g.editor[name].getValue() != g[name] && g.activetab != '_html' && g.activetab != '_addtab' && g.activetab != '_inlinetab') {
					console.log('firebasefileup', g.activetab);
					//g[g.activetab] = g.editor[name].getValue();
					nametoid(g.currentprojectref, 'files', name)
					.then(function(fileid) {
					    g.lastsave = g.editor[name].getValue();
					    g.instance = Date.now();
						g.currentprojectref.child('files').child(fileid).update({
						    instance: {time: g.instance, name:name},
							contents: g.editor[name].getValue(),
							lastchange: firebase.database.ServerValue.TIMESTAMP						
						})
					});
				}
			}
		}, 100);
	</script>
</html>