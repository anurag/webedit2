
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="/src/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
</head>
<html>
	<body>
		<div class='topbar'>
			<a id="logolink" href="/"><img id="logo" title="table of contents" src="/welogo.png"></a>
			<div id="userdrop" class="dropdown">
				<button title='List User Options' id="userbutton" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sign In
					<span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
				</button>
				<ul id="useroptions" class="dropdown-menu dropdown-menu-right">
					<li><a name='settings' href="javascript:;">Settings</a></li>
					<li><a name='zip' href="javascript:;">Download Project</a></li>
					<li><a style="color:lightgrey" name='about' href="javascript:;">About</a></li>
					<li><a name='logout' href="javascript:;">Logout</a></li>
				</ul>
			</div>
			<div title='List Project Options' id="projectdrop" class="dropdown">
				<button id="projectbutton" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
					<span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
				</button>
				<ul id="projectoptions" class="dropdown-menu">
					<li><a name='new' href="javascript:;">New Project +</a></li>
					<li><a name='open' href="javascript:;">Open Project ></a></li>
					<li><a name='share' href="javascript:;">Share Project</a></li>
					<li><a name='rename' href="javascript:;">Rename Project</a></li>
					<li><a style="color:lightgrey" name='clone' href="javascript:;">Clone Project</a></li>
					<li><a name='zip' href="javascript:;">Download All</a></li>
					<li><a style="color:red" name='archive' href="javascript:;">Delete Project</a></li>
				</ul>
			</div>
			<div class="onoff">
				<span title='Make Project Public' id='ispublic' class="glyphicon glyphicon-globe"></span>
				<span title='Make Project Read Only' id='readonly' class="glyphicon glyphicon-pencil"></span>
			</div>
		</div>
		<ul id="projectlist" class="dropdown-menu"></ul>
		<ul id="filelist" class="dropdown-menu"></ul>
		<ul id="taboptions" class="dropdown-menu">
			<li><a name='viewtab' href="javascript:;">View Tab</a></li>	
			<li><a name='edittab' href="javascript:;">Edit Tab</a></li>	
			<li><a name='globalize' href="javascript:;">Make Global</a></li>	
			<li><a style="color:red" name='delete' href="javascript:;">Delete File</a></li>
		</ul>
		<ul id="adminlist" class="dropdown-menu dropdown-menu-right"></ul>
		<div class='viewchange' id='open'>
			<a title='Open Project In Viewer' id='openlink' target="_blank" href=''>&#11008 </a>
		</div>
		<div title='Close View Window' class='viewchange' id='close'>x</div>
		<div title='Open View Window' class='viewchange' id='openview'>&#9998;</div>
		<div class='row'>	
			<div class='column'>
				<div class='tabs'>
					<button class="tab" id='_html' style="box-shadow:#505050 1px -1px 1px 0px; border-bottom:none; z-index: 5;">html</button><!--
					--><button class="tab"  id='_addtab'>...</button>
				</div>
				<div id="editor"></div>
				<div id="inlineeditor"></div>
			</div>
			<div class='column'>
				<iframe id='viewframe' src=''></iframe>
			</div>
		</div>
		<form id="fileform">
			<input id="fileupload" type="file" name="file" data-url="/upload">
		</form>
	</body>
	<style>
		#openeditlink {
			font-size: 17px;
			float: right;
			margin-right: 3px;
		}
		#taboption {
			position: absolute;
		}
		.topbar {
			display: inline-block;
			width: 100%;
		}
		.gylphicon {
			.top: 0;
		}
		#projectbutton {
			vertical-align: baseline;
			color: rgb(51, 122, 183);
			background-color: white;
			font-size: 22;
			border: none;
		}
		#projectbutton:hover {
			color: white;
			background-color: #337ab7;
		}
		.viewchange {
			font-size: 17px;
		}
		#editor {
			z-index: 6;
		}
		.onoff {
			display:inline-block;
			text-align: center;
			vertical-align:center;
		}
		#fileform {
			display: none;
		}
		#readonly {
			line-height: 40px;
			font-size: 22;
			color: #a5a5a5;
			height: 40;
			width: 40;
		}
		#readonly:hover {
			//background-color: #337ab7;
			cursor: pointer;
		}
		#ispublic {
			line-height: 40px;
			font-size: 22;
			color: #a5a5a5;
			height: 40;
			width: 40;
		}
		#ispublic:hover {
			//background-color: #337ab7;
			cursor: pointer;
		}
		.toggle.btn {
			height: 20px;
		}
		#open {
			margin-top: 11px;
			position: absolute;
			right: 14px;
			z-index: 10;
		}
		#close {
			color: red;
			margin-top: 10px;
			position: absolute;
			z-index: 10;
			right: 4px;
		}
		#openview {
			display: none;
			margin-top: 10px;
			position: absolute;
			z-index: 10;
			right: 4px;
		}
		#openview:hover {
			cursor: pointer;
		}
		#close:hover {
			cursor: pointer;
		}
		#userbutton {
			//color: black;
			//background-color: white;
			float: right;
			padding: 0;
			//border: none;
		}
		#userbutton:hover {
			background-color: #f5f5f5;
		}
		.tabx {
			z-index: 50;
			background-color: #ff6d6d;
			width: 10px;
			height: 14px;
			position: absolute;
			color: white;
			font-size: 12;
			margin: auto;
			top: -1;
			right: -1;
			opacity: .7;
		}
		.tabx:hover {
			opacity: .9;			
			background-color: #fd2b2b;
		}
		.tab {
			outline:none;
			vertical-align: middle;
			position:relative;
			white-space: normal;
			border-color: #0000002e;
			border-width: 1px;
			border-style: solid;
			font-weight: 550;
			font-size: 14;
			padding: 12px;
			padding-bottom: 30px;
			background-color: rgb(249, 249, 249);
			height: 30px;
			min-width: 45px;
		}
		.tab:hover {
			background-color: rgb(216, 216, 216);
		}
		.tabs {		
			background: #eee;
			border-radius: 0 3px 0 0;
		}
		#adminlist {
			top: 34px;
			right: 120px;
			position: absolute;
		}
		#projectdrop {
			display: inline-block;
		}
		#projectlist, #filelist {
			top: 0;
			max-height: 195px;
			position: absolute;
			overflow: auto;
		}
		#projectlist {
			margin-top: 40px;		
		}
		#filelist {
			margin-top: 52px;
		}
		#userdrop {
			float: right;
		}
		.dropdown-menu {
			min-width: 50px;
		}
		#logo {
			vertical-align: middle;
			margin-left: 5px;
			height: 30px;
		}
		#editor {
			z-index: 10px;
			height: 100%;
			align: bottom;
			right: 0;
			bottom: 0;
			left: 0;
		}
		#viewframe {
			position: absolute;
			border-top: none;
			border-bottom: 1px solid #F9F9F9;
			border-right: 1px solid #F9F9F9;
			border-left: 1px solid #F9F9F9;
		}
		.row {
			display: flex;
			margin-top: 10px;
			border-top:1pt solid #F9F9F9;
			margin-right: 0;
			margin-left: 0;
		}
		.btn {
			border-radius: 0px;
			height: 40px;
		}
	</style>
	<script>
		$('body').css({'height': (window.innerHeight)});
		$('#projectlist').css({'left': ($('#projectoptions').width() + $('#logo').width() + 12)});

		$(window).on('resize', function(){ 
			$('body').css({'height': (window.innerHeight)});
			alignlists();
			resizeframes(g.query)
		});
		
		window.onclick = function(event) {
			//console.log(event)
			//console.log($('#filelist').css("display"))
			if (event.target.name != "open" && $('#projectlist').css("display") != 'none') {
				$('#projectlist').hide();
			}
			if (event.target.id != "_addtab" && $('#filelist').css("display") != 'none') {
				$('#filelist').hide();
			}
			if (event.target.name != "makeme" && $('#adminlist').css("display") != 'none') {
				$('#adminlist').hide();
			}
			$('#taboptions').hide();
		}
		
		function alignlists() {		
			$('#projectlist').css({'left': ($('#projectoptions').width() + $('#logo').width() + 10)});
			let tablist = [];
			let change = 0;
			$('.tab').each((i, el) => tablist.push($(el).outerWidth()));
			//console.log(tablist);
			for (let i = 0; i < tablist.length; i++) {
				change = change + tablist[i];
			}
			//console.log(change);
			$('#filelist').css({'left': change});
		}
		
		function resizeframes(query) {
			//console.log(query)
			let change = ($('#userbutton').height() + $('.tabs').height() + 40)
			if (query == '?run=edit') {
				$('.row').css('border-top', '1pt solid #F9F9F9');
				$('#viewframe').css({'border-left': '1px solid #F9F9F9', 'height': (window.innerHeight - change + $('.tabs').height()), 'width': window.innerWidth/2, 'left': window.innerWidth/2});
				$('#editor').css({'height': (window.innerHeight - change), 'width': window.innerWidth/2});			
			}
			if (query == '?run=editor') {
				$('.row').css('border-top', 'none');
				$('#viewframe').css({'height': (window.innerHeight - change + $('.tabs').height()), 'width': 0, 'left': window.innerWidth});
				$('#editor').css({'height': (window.innerHeight - change), 'width': window.innerWidth});			
			}
		}

		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCtsK9Nx0Fh7YzwZ8r7V2oXw_cB0XQG4z8",
			authDomain: "webedit-204210.firebaseapp.com",
			databaseURL: "https://webedit-204210.firebaseio.com",
			projectId: "webedit-204210",
			storageBucket: "webedit-204210.appspot.com",
			messagingSenderId: "1059738201826"
		};
		firebase.initializeApp(config);
		const admin = firebase.database().ref().child('admin');
		const cookieToUidref = firebase.database().ref().child('cookieToUid');
		const root = firebase.database().ref();
		const projects = firebase.database().ref().child('projects');
		
		var usersettingsref;
		var projectsettingsref;
		let settings = {global: {},
				user: {},
				project: {}}
		settings.global.ref = firebase.database().ref().child('projects/global/-LFApck9n3U1YdCYWKEA/files/-LFApgX73wXqJW4zMz4i');
		let g = {};		
		g.shared = [];
		
		
		function parsesettings(settings) {
			//console.log(settings)
			let split = settings.split(/\r\n|\r|\n/);
			let values = {};
			for (let i = 0; i < split.length; i++) {
				if (!split[i].includes('#') && split[i] != "") {
					let object = split[i].split(': ');
					let name = object[0]
					let value = object[1]
					values[name] = value;
				}
			}
			return values;
		}
		
		g.inlineeditor = ace.edit('inlineeditor');-
		g.inlineeditor.setTheme("ace/theme/dawn");
		g.inlineeditor.getSession().setOption("ace/mode/javascript");
		let editor = ace.edit('editor');
		editor.setTheme("ace/theme/dawn");
		editor.getSession().setOption("ace/mode/javascript");
		stateObj = {foo: 'projs'};
		
		function getCook(cookiename) {
			var cookiestring = RegExp(""+cookiename+"[^;]+").exec(document.cookie);
			return decodeURIComponent(!!cookiestring ? cookiestring.toString().replace(/^[^=]+./,"") : "");
		}

		function setEditor(contents) {
			editor.setValue(contents);
			editor.gotoLine(0, 0);
			editor.focus();
		}
		
		function nametoid(ref, uid, name) {
			//console.log(uid, name);
			return ref.child(uid).orderByChild('name').equalTo(name).once('value')
			.then(function (snapshot) {
				let key;
				snapshot.forEach(function (snap) {
					if (snap.val().settings) {
						if (snap.val().settings.archived) return;
					}
					//console.log('key', snap.key)
					key = snap.key;
				});
				return key;
			});
		}		
		
		function nametoref(ref, uid, name) {
			//console.log(uid, name);
			return ref.child(uid).orderByChild('name').equalTo(name).once('value')
			.then(function (snapshot) {
				let key;
				snapshot.forEach(function (snap) {
					if (snap.val().settings) {
						if (snap.val().settings.archived) return;
					}
					//console.log('key', snap.key)
					key = snap.ref;
				});
				if (!key) {
					throw 'ref not found';
				}
				return key;
			});
		}		
		
		function listentosettings(projects, uid, project, key) {
			nametoref(projects, uid, project)
			.then(function(projectref) {
				return nametoref(projectref, 'files', '.settings');
			})
			.then(function(settingsref) {
				//console.log('settingsid', settingsref);
				settingsref.on('value', function(snapshot) {
					if (snapshot.val()) {
						settings[key] = parsesettings(snapshot.val().contents);
					} else {
						throw 'ref not found';
					}
					mergesettings();
				});
			})
			.catch(function() {
				settings[key] = {'setting': false};
				mergesettings();				
			});			
		}
		
		settings.firsttime = true;		
		function mergesettings() {
			if (!settings.firsttime || (settings.global && settings.user && settings.project)) {
				settings.settings = $.extend({}, settings.global, settings.user, settings.project);
				settings.firstime = false;
				render();
			}
		}
		
		function render() {
			//console.log(settings);
			if (settings.settings.tabColor) {
				$('.tab').css('background-color', settings.settings.tabColor);			
			} else $('.tab').css('background-color', 'rgb(249, 249, 249)');
			if (settings.settings.tabTextColor) {
				$('.tab').css('color', settings.settings.tabTextColor);
			} else $('.tab').css('color', 'black');
		}
		
		function findprojectbooleans(ref) {
			ref.child('settings').on('value', function(snapshot) {
				g.settings = snapshot.val();
				//console.log(g.settings)
				if (g.settings.ispublic) {
					$('#ispublic').css('color', '#337ab7');
					$('#ispublic').css('text-shadow', '-2px 0 white, 0 1px white, 2px 0 white, 0 -1px white');
					$('#ispublic').attr('title', 'Make Project Private');
				} else {
					$('#ispublic').css('color', '#a5a5a5');
					$('#ispublic').css('text-shadow', 'none');
					$('#ispublic').attr('title', 'Make Project Public');
				}
				if (g.settings.readonly || ((g.shared && !g.shared.includes(g.authemail)) && g.uid != g.authuid)) {
					$('#readonly').css('color', '#a5a5a5');				
					$('#readonly').css('text-shadow', 'none');
					$('#readonly').attr('title', 'Make Project Readable');
					editor.renderer.$cursorLayer.element.style.display = "none";
					editor.setOptions({
						readOnly: true,
						highlightActiveLine: false,
						highlightGutterLine: false
					});
				} else {
					$('#readonly').css('color', '#337ab7');
					$('#readonly').css('text-shadow', '-2px 0 white, 0 1px white, 2px 0 white, 0 -1px white');
					$('#readonly').attr('title', 'Make Project Read Only');
					editor.renderer.$cursorLayer.element.style.display = "";
					editor.setOptions({
						readOnly: false,
						highlightActiveLine: true,
						highlightGutterLine: true
					});
					editor.focus();
				}
			});
		}
		
		$('.onoff').on('click', 'span', function(event) {
			//console.log(event.target.id);
			if (event.target.id != '' && g.uid == g.authuid)
				if (g.settings[event.target.id]) {
					g.currentprojectref.child('settings').child(event.target.id).set(false);
				} else {			
					g.currentprojectref.child('settings').child(event.target.id).set(true);
				}
		});
		
		g.firsttime = true;
		$(function () {
			//console.log(window.location);
			[g.host, g.uid, g.projectname, g.filename] = window.location.pathname.split('/');
			$('#openlink').attr("href", window.location.origin + '/' + g.uid + '/' + g.projectname + '/');
			$('#openeditlink').attr("href", window.location.origin + '/' + g.uid + '/' + g.projectname + '/?run=editor');
			$('#logolink').attr("href", '/' + g.uid + '/');
			g.query = window.location.search;
			listentosettings(projects, 'global', 'global', 'global')
			listentosettings(projects, g.uid, 'global', 'user')
			listentosettings(projects, g.uid, g.projectname, 'project')
			//console.log(settings);
			if (g.query == "?run=editor") {
				$('#close').hide();
				$('#open').hide();
				$('#openview').show();
			}
			$('#_html').html(g.projectname);
			resizeframes(g.query);
			alignlists();
			loadfromfirebase(g.uid, $('#projectlist'));
			nametoref(projects, g.uid, g.projectname)
			.then(function(projectref) {
				g.currentprojectref = projectref;
				listfiles('files', $('#filelist'));
				g.currentprojectref.once('value')
				.then(function (snapshot) {
					g.shared = snapshot.val().shared;
					findprojectbooleans(g.currentprojectref);
					runproject(g.uid, g.projectname);
					g.contents = snapshot.val().contents;
					if (snapshot.val().activetab) {
						g.activetab = snapshot.val().activetab;
					} else g.activetab = '_html';
					setEditor(g.contents);
					slice();
					g.currentprojectref.child('contents').on('value', function(contentsnap) {
						if (contentsnap.val() != g.contents) {
							if (g.activetab == '_html' && editor.getValue() != contentsnap.val()) {
								g.contents = contentsnap.val();
								setEditor(contentsnap.val());
							} else if (g.activetab == '_inlinetab') {
								g.contents = contentsnap.val();
								editor.setValue(g.contents);
							}
							runproject(g.uid, g.projectname);
						}						
					});
					g.currentprojectref.child('activetab').on('value', function(activetabsnap) {
						console.log(activetabsnap.val())
						if (activetabsnap.val() && activetabsnap.val() != '_html') {
							let filename = activetabsnap.val().replace('.', '-');
							if (!$('#' + filename)[0]) {
								console.log(filename);
								loadtab(filename)
								addtab(filename);							
							}
						}
					});
					g.currentprojectref.child('files').on('child_changed', function(filechange) {
						//console.log('filechange', g[filechange.val().name]);
						if (g[filechange.val().name] != filechange.val().contents) {
							runproject(g.uid, g.projects);
						}
					});
					g.currentprojectref.child('shared').on('value', function(shared) {
						console.log(g.shared);
					});
				});
			});
		});		
		
		function loadtab(tabname) {
			g.currentprojectref.child('activetab').set(tabname);
		}
		
		function loadadmins(uid) {
			root.child('admin').child('admins').once('value', function (snapshot) {
				g.admins = snapshot.val();
				checkadminstatus(uid);
			});
		}
		
		function checkadminstatus(uid) {
			if (g.admins[uid]) {
				$('#useroptions').prepend('<li><a name="makeme" href="javascript:;">Change User</a></lis>')
				listadmins(projects);
			}
		}
		
		function listadmins(ref) {
			ref.on('child_added', function(snapshot) {
				//console.log(snapshot.val().email, snapshot.key);
				let html = ('<li><a id="' + snapshot.key + '" href="javascript:;">' + snapshot.val().email + '</a></li>');
				$('#adminlist').append(html);
			});
		}
		
		function loadprojects(uid, list) {
			loadfromfirebase(projects, g.uid, $('#projectlist'));
		}
		
		function listfiles(uid, list) {
			loadfromfirebase('files', $('#filelist'));
			let html = '<li><a style="border-bottom: 1px solid #d8d8d8;" id="_uploadfile" href="javascript:;">Upload File</a></li>'
			list.prepend(html);
			html = '<li><a id="_addfile" href="javascript:;">New File +</a></li>'
			list.prepend(html);
		}
		
		//<li><a name='new' href="javascript:;">New Project +</a></li>New Project +</a></li>
		function loadfromfirebase(uid, list) {
			list.html("");
			let url = '.files.json'
			if (uid != 'files') {
				url = '/' + uid + '/' + url;
			}
			$.getJSON(url)
			.then(data => {
				data.forEach(function (node) {
					if (node.name && !node.archived) {
						console.log(node);	
						let html = ('<li><a id="' + node.name + '" href="javascript:;">' + node.name + '</a></li>');
						list.append(html);
					}			
				});
			});
		}
		
		$('#openview').on('click', function () {
			top.window.history.replaceState(stateObj, name, '../' + g.projectname + '/?run=edit');
			$('#close').show();
			$('#open').show();
			$('#openview').hide();
			runproject(g.uid, g.projectname)
			resizeframes('?run=edit');
		});
		
		$('#close').on('click', function () {
			top.window.history.replaceState(stateObj, name, '../' + g.projectname + '/?run=editor');
			$('#close').hide();
			$('#open').hide();
			$('#openview').show();
			resizeframes('?run=editor');
		});
		
		$('#useroptions').on('click', 'a', function (event) {
			let option = event.target.name;
			if (option == 'settings') {
				top.window.history.pushState(stateObj, name, '../' + '.settings' + '/?run=edit');
				top.window.location.reload();
			}
			if (option == 'makeme') {
				event.stopPropagation();
				$('#adminlist').show();
			}
			if (option == 'logout') {
				logout();
				$('#logo').click();
			}
			if (option == 'zip') {
				window.open($(location).attr("origin") + '/' + g.uid + '/' + "?run=download");
				window.close();
			}
		});
		
		function addshare() {
			let email = prompt("Email of user");
			let emaillist = [];
			$('#adminlist a').each((i, el) => emaillist.push($(el).text()))
			console.log(emaillist);
			while (email && !emaillist.includes(email)) {
				email = prompt("That user does not exist please");
			}
			if (!g.shared) {
				g.shared = [email];
			} else {
				g.shared.push(email);
			}
			g.currentprojectref.child('shared').set(g.shared);
		}
		
		
		$('#projectoptions').on('click', 'a', function (event) {
			let option = event.target.name;
			if (option == 'share') {
				addshare();
			}
			if (option == 'new') {
				event.stopPropagation();
				create(projects, g.uid, "");
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'open') {
				event.stopPropagation();
				$('#projectlist').show();
			}
			if (option == 'rename') {
				renameproject();
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'archive') {
				if (confirm('Do you want to archive project ' + g.projectname + '?')) {
					g.currentprojectref.child('settings').update({
						archived: true
					});
					$('#logo').click();
				}
				loadfromfirebase(g.uid, $('#projectlist'));
			}
			if (option == 'zip') {
				window.open($(location).attr("origin") + $(location).attr("pathname") + "?run=download");
				window.close();
			}
		});
		
		$('#fileupload').change(function (event) {
			event.stopPropagation();
			let file = $('#fileupload')[0].files[0];
			let fd = new FormData();
			fd.append('file', file);
			fd.append('uid', g.uid);
			fd.append('projectname', g.projectname);
			//console.log(fd, file);
			jQuery.ajax("/upload", {
				type: "POST",
				processData: false,
				contentType: false,
				data: fd
			});
		});
		
		$('#projectlist').on('click', 'a', function (event) {
			let name = event.target.id;
			//console.log(window.location.href.split('/'))
			if (top.window.location.href.split('/')[3] != g.uid) {
				//console.log('test');
				top.window.history.pushState(stateObj, name, "/" + g.uid + '/')
			}
			top.window.history.pushState(stateObj, name, '../' + name + '/?run=edit');
			top.window.location.reload();
		});
		
		$('#filelist').on('click', 'a', function (event) {
			let name = event.target.id;	
			//console.log(name);
			if (name == "_addfile") {
				addfile(g.currentprojectref, 'files', "");
				listfiles('files', $('#filelist'));
			} else if (name == "_uploadfile") {
				$('#fileupload').click();
			} else {
				addtab(name);
			}
		});
		
		$('#adminlist').on('click', 'a', function (event) {
			let uid = event.target.id;
			if (uid != g.uid) {
				top.window.history.pushState(stateObj, name, '/' + uid + '/');
				top.window.location.reload();				
			}
		});
		
		function tabstyle(tab) {
			$('.tab').css({'box-shadow':'', 'border-bottom':'', 'z-index': 0});
			tab.css({'box-shadow':'black 0px -1px 2px 0px', 'border-bottom':'none', 'z-index': 5});		
		}
		
		function parsehtml(contents) {
			let parser = new DOMParser();
			let html = parser.parseFromString(contents, "text/html");		
			return html;
		}
		
		function findinlinetabs(contents) {
			let html = parsehtml(contents);
			let tabs = html.querySelectorAll('[we-tab]');
			tabs.forEach(function(tab) {
				addtab(tab.getAttribute('we-tab'));
			});
		}
		
		
		$('.tabs').on('click', 'span', function (event) {
			event.target.parentNode.remove();
			console.log(event.target.parentNode.id);
			let refname = event.target.parentNode.id.replace('-', '.');
			let ref = g.fileref[refname];
			ref.off();
			alignlists();
			$('#_html').click();
		});
		
		$('.tabs').on('click', 'button', function(event) {
			if (event.target.id) {
				tabstyle($(this))
				if (event.target.id == '_inlinetab') {
					console.log(event.target.id);
					g.activetab = event.target.id;					
					top.window.history.replaceState(stateObj, name, '/' + g.uid + '/' + g.projectname + '/?run=edit');
					swapeditors(true);
					setEditor(g.contents)
					console.log(g.inlinetabval)
					slice();
				} else {
					if (event.target.id == '_addtab') {
						$('#filelist').show();
					} else if (event.target.id == '_html') {
						g.activetab = event.target.id;
						top.window.history.replaceState(stateObj, name, '/' + g.uid + '/' + g.projectname + '/?run=edit');
						//console.log('2');
						setEditor(g.contents)
						swapeditors(false);					
					} else {
						g.activetab = event.target.id;
						top.window.history.replaceState(stateObj, name, g.activetab.replace('-', '.') + '?run=edit');
						//console.log('edit 1')
						editfile(g.currentprojectref, 'files', g.activetab)
						swapeditors(false);					
					}
				}
			}
		});
		
		$('.tabs').contextmenu(function (event) {
			if (!event.shiftKey && event.target.className && event.target.id != '_html' && event.target.id != "_inlinetab"  && event.target.id != "_addtab" && event.target.id != "openeditlink") {
				g.rightclicked = event.target.id.replace('-', '.');
				event.preventDefault();
				console.log(event.originalEvent);
				$('#taboptions').css({'left': event.originalEvent.pageX, 'top': event.originalEvent.pageY});
				$('#taboptions').attr('clicked', g.clicked);
				$('#taboptions').show();
			} else $('#taboptions').hide();
		});
		
		$('#taboptions').on('click', 'a', function (event) {
			let target = event.target;
			let option = target.name;
			if (option == 'viewtab') {
				$('#viewframe').attr('src', window.location.origin + '/' + g.uid + '/' + g.projectname + '/' + g.rightclicked);
			} 
			if (option == 'edittab') {
				console.log(window.location.pathname);
				window.open(window.location.origin + '/' + g.uid + '/' + g.projectname + '/' + g.rightclicked + '?run=edit');
			}
			if (option == 'delete') {
				console.log(g.activetab, g.rightclicked);
				if (g.activetab.replace('-', '.') == g.rightclicked) {
					$('#_html').click();
				}
				$('#' + g.rightclicked.replace('.', '-')).remove();
				alignlists();
				g.fileref[g.rightclicked].child('archived').set(true);
				g.fileref[g.rightclicked].off();
				listfiles('files', $('#filelist'));
			}
			if (option == 'globalize') {
				nametoref(projects, g.uid, 'global')
				.then(function(globalref) {
					return nametoref(globalref, 'files', g.rightclicked)
					.then(function (globalfilesref) {
						alert('A global file with that name already exists.');
					})
					.catch(function (err) {
						console.log(g.rightclicked, g[g.rightclicked]);
						globalref.child('files').push({'name': g.rightclicked, 'contents': g[g.rightclicked]})
					});
				})
			}
			//delete g.rightclicked;
		});
		

		function swapeditors(inline) {
			let change = ($('#userbutton').height() + $('.tabs').height() + 40)
			if (inline) {
				$('#editor').css({'height': 0, 'width': window.innerWidth/2});				
				$('#inlineeditor').css({'height': (window.innerHeight - change), 'width': window.innerWidth/2});				
			} else {
				$('#editor').css({'height': (window.innerHeight - change), 'width': window.innerWidth/2});				
				$('#inlineeditor').css({'height': 0, 'width': window.innerWidth/2});									
			}

		}
		
		g.fileref = {};
		function editfile(ref, uid, name) {
			//console.log(uid, name);
			name = name.replace('-', '.');
			//console.log(g);
			if (g[name]) {				
				//console.log('3');
				setEditor(g[name]);
			} else {
				//console.log(name)
				nametoref(ref, uid, name)
				.then(function(fileref) {
					g.fileref[name] = fileref;
					g.fileref[name].on('value', function(snapshot) {
						let namecomp = name.replace('.', '-');
						//console.log(namecomp, name, snapshot.val())
						if (g[name] != snapshot.val().contents) {
							if (g[name]) {
								runproject(g.uid, g.projectname);
							}
							g[name] = snapshot.val().contents;
						}
						if (editor.getValue() != g[name] && g.activetab == namecomp) {
							//console.log(g[name])				
							//console.log('4');
							setEditor(g[name]);
						}
					});
				});			
			}
		}
		
		function addtab(name) {
			let idname = name.replace('.', "-")
			if ($('#' + idname)[0]) {
				$('#' + idname).click();
			} else {
				let html = '<button class="tab" id="' + idname + '">' + name + '<span class="tabx">x<span></button>'
				$('#_addtab').before(html);
				$("#" + idname).click();
			} 
			alignlists();
		}
			
		function create(ref, uid, newcontents, name) {
			if (!name) {
				name = prompt("New project name?");	
			}
			name = checkname(name)
			//console.log(name)
			created = ref.child(uid).push({
				contents: newcontents,
				name: name,
				lastchange: firebase.database.ServerValue.TIMESTAMP,
				settings: {name: name,
				ispublic: false,
				archived: false,
				readonly: false,}
			})
			top.window.history.pushState(stateObj, name, '../' + name + '/?run=edit');
			top.window.location.reload();
		}

		function addfile(ref, uid, newcontents, name) {
			let filelist = [];
			if (!name) {
				name = prompt("New file name?");	
			}
			if (!name.includes('.')) {
				name = prompt("Please Specify Filetype");
			}
			$('#filelist a').each((i, el) => filelist.push(mangle($(el).text())))
			for (;;) {
				if (!filelist.includes(name)) break;
				name = prompt("That name is taken please choose another.");		
				if (!name.includes('.')) {
					name = prompt("Please Specify Filetype");
				}
			}
			let created;
			created = ref.child(uid).push({
				contents: newcontents,
				name: name,
				lastchange: firebase.database.ServerValue.TIMESTAMP,
			})
			addtab(name);
		}		
		
		
		function mangle(s) {
			return s.replace(/ /g,"_");
		}
		
		function checkname(name) {
			let namelist = [];
			$('#projectlist a').each((i, el) => namelist.push(mangle($(el).text())))
			//console.log(namelist)
			for (;;) {
				name = mangle(name);
				if (!namelist.includes(name)) break;
				name = prompt("That name is taken please choose another.");		
			}
			return name;
		}
		
		function renameproject() {
			let newname = prompt('What would you like to rename project: ' + g.projectname + '?');
			newname = checkname(newname)
			g.currentprojectref.child('settings').update({
				name: newname,
			});
			g.currentprojectref.update({
				name: newname,
			});								
			top.window.history.pushState(stateObj, name, '../' + newname + '/?run=edit');
			top.window.location.reload();
		}

		function slice() {
			let lines = editor.session.doc.getAllLines();
			let inlinetabname;
			let startline;
			let endline;
			for (let i = 0; i < lines.length; i++) {
				//console.log('line:', i, lines[i]);
				if (!startline) {
					if (lines[i].includes('<script') && lines[i].includes('we-tab')) {
						startline = i + 1;
						[,,inlinetabname] = lines[i].match(/we-tab=(['"])(.*?)\1/);
						//console.log(tabname);
					}
				} else {
					lines[i] = lines[i]
					if (lines[i].includes('</scr' + 'ipt>')) {
						endline = i - 1;
						break;
					}
				}
			}
			if (!startline || !endline) return;
			if (!$('#_inlinetab')[0]) {
				$('#_html').after('<button class="tab" id="_inlinetab">' + inlinetabname + '</button>');
			}
			g.inlinetabval = lines.slice(startline, endline + 1);
			for (let i = 0; i < g.inlinetabval.length - 1; i++) {
				g.inlinetabval[i] = g.inlinetabval[i] + '\n';
			}
			g.inlineeditor.setValue(g.inlinetabval.join(""));
			//rebuild(startline, endline);
			alignlists();
		}
		
		function rebuild(start, end) {
			let alllines = editor.session.doc.getAllLines();
			let lines = g.inlineeditor.session.doc.getAllLines();
			let startline;
			let endline;
			//console.log(alllines, lines)
			for (let i = 0; i < alllines.length; i++) {
				if (!startline) {
					if (alllines[i].includes('<script') && alllines[i].includes('we-tab')) {
						startline = i + 1;
					}
				} else {
					if (alllines[i].includes('</scr' + 'ipt>')) {
						endline = i - 1;
						break;
					}
				}
			}
			alllines.splice(startline, endline - startline + 1, ...lines);
			for (let i = 0; i < alllines.length - 1; i++) {
				alllines[i] = alllines[i] + '\n';
			}
			alllines.splice(alllines.length - 1, 1);
			console.log('rebuild');
			editor.setValue(alllines.join(''));
		}
		
		editor.session.on('change', function() {
			if (g.activetab == '_html' && editor.getValue() != g.contents) {
				console.log('slice');
				slice();
			}
			g.dirtyTime = Date.now();
		});
		
		$(editor.textInput.getElement()).keydown(function () {
			//console.log('key')
			g.dirtyTime = Date.now();
		});
		
		$(g.inlineeditor.textInput.getElement()).keydown(function () {
			//console.log('key')
			if (g.dirtyTime) g.dirtyTime = Date.now();
		});

		g.inlineeditor.session.on('change', function() {
			if (g.inlineeditor.getValue() != g.inlintabval && g.activetab == "_inlinetab") {
				console.log('rebuild')
				rebuild()
			}
			g.dirtyTime = Date.now();
		});
		
		$('#userbutton').click(function(event) {
			console.log('userbutton');
			if (g.authuid) {

			} else {
				let provider = new firebase.auth.GoogleAuthProvider();
				firebase.auth().signInWithPopup(provider).then(function(result) {
				}).catch(function(error) {
				});
			}
		});
		
		firebase.auth().onAuthStateChanged(function (user) {
			if (user) {
				$('#userbutton').html(user.email.split("@")[0])
				g.cookieId = getCook('cookieId');
				g.authemail = user.email;
				g.authuid = user.uid;
				$('#userbutton').css({'background-color': 'white', 'border': 'none'});
				$('#userbutton').html('<div style="display: inline-block; color: #abcff5; margin-right: 5px;"><img style="border-radius: 50%; height: 38px; padding: 5px;" src="' + user.photoURL + '"></img><span class="glyphicon glyphicon-triangle-bottom"></span>');
				root.child('cookieToUid').child(g.cookieId).set(g.authuid);
				loadadmins(g.authuid);
			}
		});		

		function logout() {
			firebase.auth().signOut().then(function() {
				window.history.pushState(stateObj, "page 2", "/")
				window.location.reload();
			}, function(error) {
				// An error happened.
			});
		};

		function setItem(key, val) {
		    localStorage.setItem(key, JSON.stringify(val));
		}
		function getItem(key) {
		    return JSON.parse(localStorage.getItem(key));
		}
        function crashed_set(project, val) {
            let crashed = getItem('crashed_by_project') || {};
            //console.log('crashed_by_project', crashed);
            crashed[project] = crashed[project] || {};
            crashed[project].crashed = val;
            setItem('crashed_by_project', crashed);
        }
        function crashed_get(project) {
			$('#line').show();
			$('#rframe').show();
			$('#lframe').show();
			let crashed = getItem('crashed_by_project') || {};
            crashed[project] = crashed[project] || {};
            return (crashed[project] || {}).crashed;
        }	
		let crash_timer_handle;
		function runproject(uid, projectname) {
			console.log('run', uid, projectname)
			if (g.query == '?run=edit') {
				console.log('crashed', crashed_get(projectname))
				if (crashed_get(projectname)) {
					$('#viewframe')[0].contentWindow.location = '?run=crashed';
					return;
				}			
				crashed_set(projectname, true);
				if (crash_timer_handle) clearTimeout(crash_timer_handle)	
				crash_timer_handle = setTimeout(function () {crashed_set(projectname, false)}, 1000)
				let src = '/' + uid + '/'  + projectname + '/';
				let viewframe = $('#viewframe')[0];
				if ($('#viewframe')[0].contentWindow.location.href == 'about:blank') {
					//console.log('replace')
					$('#viewframe')[0].contentWindow.location.replace(src);	
				} else {
					//console.log('reload')
					$('#viewframe')[0].contentWindow.location.reload();
				}
			}
		}
		
		g.dirtyTime = null;
		setInterval(function () {
			if (g.dirtyTime && Date.now() - g.dirtyTime > 2000) {
				let name = g.activetab.replace('-', '.')
				//console.log(name)
				g.dirtyTime = null;
				if (editor.getValue() != g.contents && (g.activetab == '_html' || g.activetab == '_inlinetab')) {
					console.log('firebaseprojectup');
					//g.contents = editor.getValue();
					g.currentprojectref.update({
						contents: editor.getValue(),
						lastchange: firebase.database.ServerValue.TIMESTAMP
					});
				} else if (editor.getValue() != g[g.activetab] && g.activetab != '_html' && g.activetab != '_addtab' && g.activetab != '_inlinetab') {
					console.log('firebasefileup', g.activetab);
					//g[g.activetab] = editor.getValue();
					nametoid(g.currentprojectref, 'files', name)
					.then(function(fileid) {
						g.currentprojectref.child('files').child(fileid).update({
							contents: editor.getValue(),
							lastchange: firebase.database.ServerValue.TIMESTAMP						
						})
					});
				}
			}
		}, 100);
	</script>
</html>